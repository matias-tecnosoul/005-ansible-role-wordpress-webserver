---
# Tareas específicas para RedHat/CentOS/Rocky

- name: Instalar repositorio EPEL
  ansible.builtin.dnf:
    name: epel-release
    state: present
  tags: [packages, repo]

- name: Remover curl-minimal si existe (Rocky Linux fix)
  ansible.builtin.dnf:
    name: curl-minimal
    state: absent
  failed_when: false
  tags: [packages]

- name: Instalar paquetes necesarios para WordPress
  ansible.builtin.dnf:
    name: "{{ redhat_packages }}"
    state: present
  tags: [packages]

- name: Configurar Apache para mod_php (Rocky Linux)
  ansible.builtin.copy:
    content: |
      # PHP file handling
      <FilesMatch \.php$>
          SetHandler application/x-httpd-php
      </FilesMatch>
      
      DirectoryIndex index.html index.php
    dest: /etc/httpd/conf.d/php.conf
    backup: true
  notify: restart httpd
  tags: [php]

- name: Configurar firewall para HTTP/HTTPS
  ansible.posix.firewalld:
    service: "{{ item }}"
    permanent: true
    state: enabled
    immediate: true
  loop:
    - http
    - https
  failed_when: false
  tags: [firewall]

- name: Configurar SELinux para WordPress (básico)
  ansible.posix.seboolean:
    name: "{{ item }}"
    state: true
    persistent: true
  loop:
    - httpd_can_network_connect
    - httpd_can_network_connect_db
  failed_when: false
  tags: [selinux]

- name: Crear directorio de WordPress
  ansible.builtin.file:
    path: "{{ wordpress_install_dir }}"
    state: directory
    owner: "{{ wordpress_user }}"
    group: "{{ wordpress_group }}"
    mode: "0755"
  tags: [wordpress, directories]
